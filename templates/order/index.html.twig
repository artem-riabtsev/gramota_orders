{% extends 'base.html.twig' %} 

{% block content %}
<h1>Заказы</h1>

<button class="btn btn-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
    Показать / скрыть фильтр
</button>

<div class="collapse" id="filterCollapse">
    <div class="card card-body mb-4">
        <form method="get" action="{{ path('app_order_index') }}">
            <div class="row g-3">
                <div class="col-md-2">
                    <label for="filterId" class="form-label">Номер заказа</label>
                    <select id="filterId" name="id" class="form-select">
                        <option value="">Все</option>
                        {% for o in allOrders %}
                            <option value="{{ o.id }}" {% if filters.id is defined and filters.id == o.id %}selected{% endif %}>
                                {{ o.id }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="filterDateFrom" class="form-label">Дата заказа с</label>
                    <input type="date" class="form-control" id="filterDateFrom" name="date_from" value="{{ app.request.get('dateFrom') }}">
                </div>
                <div class="col-md-3">
                    <label for="filterDateTo" class="form-label">Дата заказа по</label>
                    <input type="date" class="form-control" id="filterDateTo" name="date_to" value="{{ app.request.get('dateTo') }}">
                </div>

                <div class="col-md-2">
                    <label for="filterAmountMin" class="form-label">Мин. сумма заказа</label>
                    <input type="number" step="0.01" class="form-control" id="filterAmountMin" name="amount_min" value="{{ app.request.get('amountMin') }}">
                </div>
                <div class="col-md-2">
                    <label for="filterAmountMax" class="form-label">Макс. сумма заказа</label>
                    <input type="number" step="0.01" class="form-control" id="filterAmountMax" name="amount_max" value="{{ app.request.get('amountMax') }}">
                </div>

                <div class="col-md-3">
                    <label for="filterPaymentDateFrom" class="form-label">Дата оплаты с</label>
                    <input type="date" class="form-control" id="filterPaymentDateFrom" name="payment_date_from" value="{{ app.request.get('paymentDateFrom') }}">
                </div>
                <div class="col-md-3">
                    <label for="filterPaymentDateTo" class="form-label">Дата оплаты по</label>
                    <input type="date" class="form-control" id="filterPaymentDateTo" name="payment_date_to" value="{{ app.request.get('paymentDateTo') }}">
                </div>

                <div class="col-md-2">
                    <label for="filterPaymentAmountMin" class="form-label">Мин. сумма оплаты</label>
                    <input type="number" step="0.01" class="form-control" id="filterPaymentAmountMin" name="payment_amount_min" value="{{ app.request.get('paymentAmountMin') }}">
                </div>
                <div class="col-md-2">
                    <label for="filterPaymentAmountMax" class="form-label">Макс. сумма оплаты</label>
                    <input type="number" step="0.01" class="form-control" id="filterPaymentAmountMax" name="payment_amount_max" value="{{ app.request.get('paymentAmountMax') }}">
                </div>

                <div class="col-md-2">
                    <label for="filterCustomerId" class="form-label">ID заказчика</label>
                    <select id="filterCustomerId" name="customer_id" class="form-select">
                        <option value="">Все</option>
                        {% for c in allCustomers %}
                            <option value="{{ c.id }}" {% if filters.customerId is defined and filters.customerId == c.id %}selected{% endif %}>
                                {{ c.id }} {% if c.name is defined %} - {{ c.name }}{% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <label for="filterStatus" class="form-label">Статус</label>
                    <select id="filterStatus" class="form-select" name="status">
                        <option value="" {% if app.request.get('status') is empty %}selected{% endif %}>Все</option>
                        <option value="0" {% if app.request.get('status') == '0' %}selected{% endif %}>Незавершен</option>
                        <option value="1" {% if app.request.get('status') == '1' %}selected{% endif %}>Завершен</option>
                    </select>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Применить фильтр</button>
                    <a href="{{ path('app_order_index') }}" class="btn btn-secondary">Сбросить</a>
                </div>
            </div>
        </form>
    </div>
</div>

<table class="table table-hover table-bordered align-middle">
    <thead>
        <tr>
            <th>Номер заказа</th>
            <th>Дата заказа</th>
            <th>Сумма заказа</th>
            <th>Дата оплаты</th>
            <th>Сумма оплаты</th>
            <th>Заказчик</th>
            <th>Статус</th>
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
    {% for order in orders %}
        <tr>
            <td>{{ order.id }}</td>
            <td>{{ order.date ? order.date|date('Y-m-d') : '' }}</td>
            <td>{{ order.amount }}</td>
            <td>{{ order.paymentDate ? order.paymentDate|date('Y-m-d') : '' }}</td>
            <td>{{ order.paymentAmount }}</td>
            <td>{{ order.customer.id }}</td>
            <td class='{{ order.status == 0 ? 'table-danger' : 'table-success' }}'>
                {{ order.status == 0 ? 'Незавершен' : 'Завершен' }}
            </td>
            <td>
                <div class="d-flex">
                    {% if order.status == 0 %}
                    <a href="{{ path('app_order_edit', {'id': order.id}) }}" class="btn btn-sm btn-outline-warning me-2">Корзина</a>
                    <form method="post" action="{{ path('app_order_complete', {'id': order.id}) }}" class="me-2">
                        <input type="hidden" name="_token" value="{{ csrf_token('complete' ~ order.id) }}">
                        <button class="btn btn-sm btn-outline-success">Завершить</button>
                    </form>
                    {% endif %}
                    <form method="post" action="{{ path('app_order_delete', {'id': order.id}) }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ order.id) }}">
                        <button class="btn btn-sm btn-outline-danger"
                            {% if order.paymentAmount or order.paymentDate %}disabled{% endif %}>
                            Удалить
                        </button>
                    </form>
                </div>
            </td>
        </tr>
    {% else %}
        <tr>
            <td colspan="7">Заказы ненайдены</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
<a href="{{ path('app_order_new') }}" class="btn btn-primary">Создать новый заказ</a>

{% endblock %}
